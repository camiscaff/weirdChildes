---
title: "childes_weird"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

https://rpubs.com/gloukatou/733656




## R Markdown

```{r libraries, message=FALSE, warning=FALSE}

read.csv("childes_metrics.csv")->x

#devtools::install_github("unDocUMeantIt/koRpus.lang.fr") # stable release


#library(childesr)
#library(wordbankr)
library(ggplot2)
library(dplyr)
library(tidyr)
library(purrr)
require(scales)
library(stringr)
library(kableExtra)
library(WDI)


library(RColorBrewer)
myPalette <- brewer.pal(5, "Set2") 


group_count <-function(data_, column_){
data_<- data_ %>%
  group_by({{column_}}) %>%
    count() 
      return(data_)
}

group_select<-function(data_, column_){
data_ <- data_%>%
    group_by(!!column_) %>%
      select(Corpus, !!column_)
data_ <- data_[ order( data_[,3] ),]
return(data_)
}
```

# Load annotations 

```{r load annotations}

#####TODOS first part is the descriptive section, to what extent the full range of populations is represented, what are some codes that are missing often,
##### descriptive section and representation of the population
##########systematic review of features
##################confront eg proportion of child population versus proportion of data by eg continent
#############second goal: point out strengths and limitations of the current CHILDES, explain what is missing

annotations<- read.csv("Table for authors - annotations.csv") 
colnames(annotations)[colnames(annotations)=="X..of.children.with.siblings"]<-"Nb.of.children.with.siblings"
colnames(annotations)[colnames(annotations)=="X..of.children.with.older.siblings"]<-"Nb.of.children.with.older.siblings"
colnames(annotations)=gsub("\\.\\..*","",colnames(annotations))
colnames(annotations)[colnames(annotations)=="Our.coding.of"]<-"Our.coding.of.community.type"

annotations$Number.of.participants[annotations$Number.of.participants=="1 or 5"]<-NA
annotations$Number.of.participants[annotations$Number.of.participants=="1 CHI + MOT/FAT/INV"]<-1
annotations$Number.of.participants[annotations$Number.of.participants=="4 CHI + MOTs, some FATs, some SIBs"]<-4
annotations$Number.of.participants=as.numeric(as.character(annotations$Number.of.participants))

annotations$Nb.of.children.with.siblings=as.numeric(as.character(annotations$Nb.of.children.with.siblings))

annotations$Proportion.With.Siblings=annotations$Nb.of.children.with.siblings/annotations$Number.of.participants

#table(annotations$Household.structure)
annotations$Household.structure=tolower(annotations$Household.structure)
annotations$Household.structure[grep("different|diverse|varied",annotations$Household.structure)] <- NA #turn to NA?
annotations$Household.structure[annotations$Household.structure %in% c("nuclear, extended","extended/nuclear")]<-"varied"
annotations$Household.structure[grep("nuclear|nucear|single",annotations$Household.structure)]<-"nuclear" # including single parent
annotations$Household.structure[grep("extended",annotations$Household.structure)]<-"extended"
annotations$Household.structure[annotations$Household.structure==""]<-NA


# Education & SES cleaning
annotations$Education.Naomi[annotations$Education.Naomi==""]<-NA
annotations$Education.min<-gsub("-.*","",annotations$Education.Naomi)
annotations$Education.max<-gsub(".*-","",annotations$Education.Naomi)
annotations$Education.mid<-as.numeric(as.character(annotations$Education.min))+(as.numeric(as.character(annotations$Education.max))-as.numeric(as.character(annotations$Education.min)))/2

annotations$SES.Naomi[annotations$SES.Naomi==""]<-NA
annotations$SES.min<-gsub("-.*","",annotations$SES.Naomi)
annotations$SES.max<-gsub(".*-","",annotations$SES.Naomi)
annotations$SES.max[grep("upper",annotations$Parental.socioeconomic.status)]<-3

annotations$SES.mid<-as.numeric(as.character(annotations$SES.min))+(as.numeric(as.character(annotations$SES.max))-as.numeric(as.character(annotations$SES.min)))/2


```

`r nrow(annotations)` corpora annotated. 



```{r group_by inclusion}

include<- annotations %>%
  mutate(inclusion=tolower(Inclusion)) %>%
  mutate(inclusion = ifelse(str_detect(inclusion, "yes"), "yes", "no")) %>%
  group_by(inclusion) %>%
  count() 

ggplot(include,aes(y=n, x=inclusion)) +
  geom_bar(stat="identity", width=1, color="white") +
  theme_minimal() + 
  ggtitle("Corpus inclusion") 

annotations <- annotations %>%
  filter(Inclusion=="yes")

```
From the total amount of corpora, `r nrow(annotations)` have been included in this study. The following analyses will continue only on these included corpora.



```{r group_by location_cleaning}

annotations$country <-NA
annotations$continent <-NA


annotations$country[grep("Ireland", annotations$Location)]  <- "Ireland"
annotations$country[grep("England|Arfon area Gwynedd, North Wales|Belfast, Northern Ireland|Nottingham/Manchester, England|England, Brighton|Wales", annotations$Location)]  <- "United Kingdom"
annotations$country[grep("Portugal", annotations$Location)]  <- "Portugal"
annotations$country[grep("Spain|Madrid, Spain ; Tenerife, Canary Islands|Madrid, Spain|Navarra, Spain|Alt penedes, region of catalonia|spain| Lloret de mar|Barcelona| SPAIN|Salamanca|Lugo", annotations$Location)]  <- "Spain"
annotations$country[grep("France|France (Normandy, Marseille, + places visited)", annotations$Location)]  <- "France"
annotations$country[grep("Naples|italy|Roma", annotations$Location)]  <- "Italy"
annotations$country[grep("Switzerland", annotations$Location)]  <- "Switzerland"
annotations$country[grep("Belgium", annotations$Location)]  <- "Belgium"
annotations$country[grep("Germany", annotations$Location)]  <- "Germany"
annotations$country[grep("Netherlands", annotations$Location)]  <- "Netherlands"

#Following the EuroVoc classification https://en.wikipedia.org/wiki/EuroVoc + Italy and Spain and Portugal
annotations$continent[grep("Andorra|Austria|Belgium|France|Germany|Ireland|Italy|Liechtenstein|Luxembourg|Monaco|Netherlands|Portugal|Spain|Switzerland|United Kingdom", annotations$country)]  <- "Western Europe"


annotations$country[grep("Poznań, Poland", annotations$Location)]  <- "Poland"
annotations$country[grep("Estonia|Tartu, Estonia ; Rapla, Estonia|Southern Estonia|Tartu, Estonia", annotations$Location)]  <- "Estonia"
annotations$country[grep("Hungary", annotations$Location)]  <- "Hungary"
annotations$country[grep("Czech Republic", annotations$Location)]  <- "Czech Republic"
annotations$country[grep("Bucharest, Romania|Romania", annotations$Location)]  <- "Romania"
annotations$country[grep("Serbia", annotations$Location)]  <- "Serbia"
annotations$country[grep("Croatia", annotations$Location)]  <- "Croatia"
annotations$country[grep("Slovenia", annotations$Location)]  <- "Slovenia"

annotations$country[grep("Sweden", annotations$Location)]  <- "Sweden"
annotations$country[grep("Iceland", annotations$Location)]  <- "Iceland"
annotations$country[grep("Norway", annotations$Location)]  <- "Norway"
annotations$country[grep("Denmark", annotations$Location)]  <- "Denmark"

annotations$country[grep("Athens, Greece", annotations$Location)]  <- "Greece"

annotations$country[grep("Moscow, Russia", annotations$Location)]  <- "Russia"

annotations$continent[grep("Poland|Estonia|Hungary|Czech|Romania|Serbia|Croatia|Slovenia|Sweden|Iceland|Norway|Denmark|Greece|Russia", annotations$country)]  <- "Non-Western Europe"


annotations$country[grep("Turkey", annotations$Location)]  <- "Turkey"
annotations$country[grep("Iran", annotations$Location)]  <- "Iran"
annotations$country[grep("Israel|Yahud, Israel", annotations$Location)]  <- "Israel"
annotations$country[grep("Kuwait", annotations$Location)]  <- "Kuwait"

annotations$country[grep("Bombay, India", annotations$Location)]  <- "India"

annotations$country[grep("China", annotations$Location)]  <- "China"

annotations$country[grep("Singapore", annotations$Location)]  <- "Singapore"
annotations$country[grep("Indonesia", annotations$Location)]  <- "Indonesia"
annotations$country[grep("Bangkok, Thailand", annotations$Location)]  <- "Thailand"
annotations$country[grep("Osaka|Tokyo|Nagoya|osaka|Kusatsu City, Shiga Pref", annotations$Location)]  <- "Japan"
annotations$country[grep("Korea", annotations$Location)]  <- "Korea" #NOTE: one corpus just says "Korea", data collected in 2009-2011, assuming it's South Korean
annotations$country[grep("Hong-Kong", annotations$Location)]  <- "Hong Kong"
annotations$country[grep("Taiwan", annotations$Location)]  <- "Taiwan"

annotations$continent[grep("Turkey|Iran|Israel|Kuwait|India|China|Singapore|Indonesia|Thailand|Japan|Korea|Hong Kong|Taiwan", annotations$country)]  <- "Asia"


annotations$country[grep("Papua-New Guinea", annotations$Location)]  <- "Papua New Guinea"
annotations$continent[grep("Papua New Guinea", annotations$country)]  <- "Oceania"


annotations$country[grep("Alexandria, Egypt", annotations$Location)]  <- "Egypt"
annotations$country[grep("Mokhotlong, Lesotho", annotations$Location)]  <- "Lesotho"
annotations$country[grep("South Africa", annotations$Location)]  <- "South Africa"
annotations$continent[grep("Egypt|Lesotho|Africa", annotations$country)]  <- "Africa"


annotations$country[grep("Rio Cuarto, Cordoba, Argentina", annotations$Location)]  <- "Argentina"
annotations$country[grep("Sao Paulo", annotations$Location)]  <- "Brazil"
annotations$country[grep("Mexico", annotations$Location)]  <- "Mexico"
annotations$country[grep("Jamaica", annotations$Location)]  <- "Jamaica"
annotations$continent[grep("Argentina|Brazil|Mexico|Jamaica", annotations$country)]  <- "Latin America"

annotations$country[grep("Michigan, USA|USA, Northern Virginia|California, USA|washington dc|United States|USA|Washington|Maryland|San Fran", annotations$Location)]  <- "United States"
annotations$country[grep("Canada", annotations$Location)]  <- "Canada"
annotations$continent[grep("United States|Canada", annotations$country)]  <- "North America"


#Special cases
annotations$country[grep("Sweden ; Portugal", annotations$Location)]  <- "Sweden & Portugal"
annotations$country[grep("Spain (Lloret de Mar), Hungary (Kecskemét)", annotations$Location)]  <- "Spain & Hungary"
#We are leaving continent as NA (because one country is Western & the other Eastern Europe)


#to check if any left
#annotations[is.na(annotations$country),"Location"]
#annotations[is.na(annotations$continent),"Location"]





```

```{r cleaning type}

annotations$Type.of.community.at.the.time.of.the.recordings[is.na(annotations$Type.of.community.at.the.time.of.the.recordings)]<-annotations$Naomi.community.type[is.na(annotations$Type.of.community.at.the.time.of.the.recordings)]

annotations$Type.of.community.at.the.time.of.the.recordings[annotations$Type.of.community.at.the.time.of.the.recordings %in% c("academic","capital city of the Soviet Union","city","industial","industrial ","work-for-pay",
                                                                                                                               "industrial & service &trade activities...","industrial city (3.000.000 inhabitants",
                                                                                                                               "Industrial city (population: around 272,000 inhabitants)",
                                                                                                                               "Mediterranean city of 1.6 million inhabitants",
                                                                                                                               "modern city families, usually both working parents",
                                                                                                                               "Orthodox Jews",
                                                                                                                               "Seaside tourist town",
                                                                                                                               "work-for-pay/industrial","industrial")]<-"urban"

annotations$Type.of.community.at.the.time.of.the.recordings[annotations$Type.of.community.at.the.time.of.the.recordings %in% c("farmer","rural","rural farming village")]<-"rural"

annotations$Type.of.community.at.the.time.of.the.recordings[annotations$Type.of.community.at.the.time.of.the.recordings %in% c("industrial, farmers")]<-"both"
table(annotations$Type.of.community.at.the.time.of.the.recordings)
```



```{r ancillary data}
byPart<- annotations %>%
  select(Language.or.Languages.spoken.in.recordings, Number.of.participants) %>%
   filter(!is.na(Number.of.participants)) %>%
     group_by(Language.or.Languages.spoken.in.recordings) %>%
       summarise(numpar = sum(as.numeric(Number.of.participants))) 


read.csv("country_iso.csv")->iso_lookup
codes=iso_lookup$Code
iso_lookup$Name<-as.character(iso_lookup$Name)
iso_lookup$Name=gsub(", Islamic Republic of","",iso_lookup$Name)
iso_lookup$Name=gsub("Russian Federation","Russia",iso_lookup$Name)
iso_lookup$Name=gsub(", Province of China","",iso_lookup$Name)
iso_lookup$Name=gsub(", Republic of","",iso_lookup$Name)

names(codes)<-iso_lookup$Name

annotations$country_WB<-codes[annotations$country]

annotations$country_WB <-factor(annotations$country_WB)
annotations[is.na(annotations$country_WB),"country"]


annotations$continent <-factor(annotations$continent)
# Indices
# WDIsearch('gdp')
#"GDP per capita, PPP (constant 2005 international $)"
# WDIsearch('Educational attainment, at least')
# Naomi: secondary, some college, university, 
# WDI:  SE.SEC.CUAT.LO.ZS    "Educational attainment, at least completed lower secondary, population 25+, total (%) (cumulative)" -- 62 countries are NOT NA
# WDI:  SE.SEC.CUAT.UP.ZS   Educational attainment, at least completed upper secondary, population 25+, total (%) (cumulative) -- 66 countries are NOT NA
# WDI:  SE.TER.CUAT.BA.ZS   Educational attainment, at least Bachelor's or equivalent, population 25+, total (%) (cumulative) -- only 25 countries are not NA
# note, only 23 countries have all three... 

## ADD
# "SH.FPL.IDLC.Q3" "Mean ideal number of children (per woman): Q3"
# "SP.DYN.CEBN.Q3" "Mean number of children ever born to women aged 40-49: Q3" 


dat_all = WDI(indicator=c('NY.GDP.PCAP.PP.KD','SE.SEC.CUAT.UP.ZS','SP.RUR.TOTL.ZS','5.01.01.01.indust','SP.DYN.CEBN.Q3'), start=2012, end=2012)


dat = WDI(indicator=c('NY.GDP.PCAP.PP.KD','SE.SEC.CUAT.UP.ZS','SP.RUR.TOTL.ZS','5.01.01.01.indust','SP.DYN.CEBN.Q3'), country=c(levels(annotations$country_WB)), start=2012, end=2012)

# flip %rur
dat_all$SP.URB.TOTL.ZS=1-dat_all$SP.RUR.TOTL.ZS
dat$SP.URB.TOTL.ZS=1-dat$SP.RUR.TOTL.ZS

annotations=merge(annotations,dat,by="country",all.x=T)

table(!is.na(annotations$SES.mid),!is.na(annotations$NY.GDP.PCAP.PP.KD))
table(!is.na(annotations$Education.mid),!is.na(annotations$SE.SEC.CUAT.UP.ZS))
table(!is.na(annotations$Type.of.community.at.the.time.of.the.recordings),!is.na(annotations$SP.URB.TOTL.ZS))
            


```

# At the level of the population

## Western

There are corpora for every continent, although more corpora in Europe than other continents:

```{r tab x cont}
kable(table(annotations$continent))

```


```{r nch x cont}
mytab=aggregate(annotations$Number.of.participants,by=list(annotations$continent),sum)
colnames(mytab)<-c("Continent","Number of children")
kable(mytab)

```
## Educated



```{r}
dens_dat=data.frame(rbind(cbind(dat_all$SE.SEC.CUAT.UP.ZS[!is.na(dat_all$SE.SEC.CUAT.UP.ZS)],0),
               cbind(dat$SE.SEC.CUAT.UP.ZS[!is.na(dat$SE.SEC.CUAT.UP.ZS)],1) ))
colnames(dens_dat)<-c("completed.HS","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

ggplot(dens_dat, aes(x = completed.HS, fill = in.childes)) + geom_density(alpha = 0.5)


```


## Urban versus rural

```{r }
dens_dat=data.frame(rbind(cbind(dat_all$SP.URB.TOTL.ZS[!is.na(dat_all$SP.URB.TOTL.ZS)],0),
               cbind(dat$SP.URB.TOTL.ZS[!is.na(dat$SP.URB.TOTL.ZS)],1) ))
colnames(dens_dat)<-c("pc.rural","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

ggplot(dens_dat, aes(x = pc.rural, fill = in.childes)) + geom_density(alpha = 0.5)

```


## Rich



```{r}

dens_dat=data.frame(rbind(cbind(dat_all$NY.GDP.PCAP.PP.KD[!is.na(dat_all$NY.GDP.PCAP.PP.KD)],0),
               cbind(dat$NY.GDP.PCAP.PP.KD[!is.na(dat$NY.GDP.PCAP.PP.KD)],1) ))
colnames(dens_dat)<-c("GDP.per.capita","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

ggplot(dens_dat, aes(x = GDP.per.capita, fill = in.childes)) + geom_density(alpha = 0.5)

```

## Family size
```{r}

dens_dat=data.frame(rbind(cbind(dat_all$SP.DYN.CEBN.Q3[!is.na(dat_all$SP.DYN.CEBN.Q3)],0),
               cbind(dat$SP.DYN.CEBN.Q3[!is.na(dat$SP.DYN.CEBN.Q3)],1) ))
colnames(dens_dat)<-c("N.children.woman","in.childes_T")
dens_dat$in.childes=ifelse(dens_dat$in.childes,"CHILDES","all")

ggplot(dens_dat, aes(x = N.children.woman, fill = in.childes)) + geom_density(alpha = 0.5)

```

# At the level of the family

## Educated



```{r}
plot(annotations$Education.mid~annotations$SE.SEC.CUAT.UP.ZS,xlab="Proportion of the population finishing high school",ylab="Education level in the CHILDES sample",yaxt="n")
axis(2,at=1:5,labels=c("primary", "secondary","some college","college","postgraduate"),las=2)
```


## Urban versus rural



```{r tab x rur/urb}
kable(table(annotations$Type.of.community.at.the.time.of.the.recordings))
#annotations[!is.na(annotations$Type.of.community.at.the.time.of.the.recordings) & !is.na(annotations$SP.URB.TOTL.ZS),c("Type.of.community.at.the.time.of.the.recordings","SP.URB.TOTL.ZS")]

boxplot(annotations$SP.URB.TOTL.ZS ~ annotations$Type.of.community.at.the.time.of.the.recordings,type='n')
points(annotations$SP.URB.TOTL.ZS ~ jitter(as.numeric(as.factor(annotations$Type.of.community.at.the.time.of.the.recordings))))
```


```{r nch x rur/urb}
mytab=aggregate(annotations$Number.of.participants,by=list(annotations$Type.of.community.at.the.time.of.the.recordings),sum)
colnames(mytab)<-c("Setting","Number of children")
kable(mytab)

```


## Rich

This graph isn't good, but we don't know exactly how to convey this.


```{r, eval=F}
plot(annotations$SES.mid~annotations$NY.GDP.PCAP.PP.KD,xlab="GDP per capita",ylab="SES in the CHILDES sample",yaxt="n")
axis(2,at=1:3,labels=c("lower", "middle","upper"),las=2)
```

## Household structure

```{r nuclear vs extended}
table(annotations$Household.structure)
```


## Siblings

- change to histogram
- show proportion of corpora that have at least one child with sibling

```{r prop kids with sibs}

summary(annotations$Proportion.With.Siblings)
plot(density(annotations$Proportion.With.Siblings[!is.na(annotations$Proportion.With.Siblings)]))
```



```{r group_by siblings, warning=FALSE, message=FALSE}

bySiblnum<-annotations %>%
    group_by(Average.number.of.siblings) %>%
      count()

ggplot(bySiblnum, mapping = aes(x=Average.number.of.siblings, y=n)) + 
  geom_point() + 
    ggtitle("Average number of siblings per corpus") + 
      geom_col()

#ggplot(bySiblnum[!is.na(bySiblnum$Average.number.of.siblings),], mapping = aes(x=Average.number.of.siblings, y=n)) 

annotations$Average.number.of.siblings <- as.numeric(as.character(annotations$Average.number.of.siblings))
head(bySiblnum)
```

The mean number of  siblings has been left NA for `r bySiblnum[is.na(bySiblnum$Average.number.of.siblings),]$n` out of `r sum(bySiblnum$n)` corpora. In the remaining corpora, the mean number of siblings per corpus is `r mean(annotations[!is.na(annotations$Average.number.of.siblings),]$Average.number.of.siblings, na.rm=TRUE)` with min `r min(annotations[!is.na(annotations$Average.number.of.siblings),]$Average.number.of.siblings)` and max `r max(annotations[!is.na(annotations$Average.number.of.siblings),]$Average.number.of.siblings)`.

